<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>IoT Health Monitor ‚Äî Professional Demo</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --bg:#f6f9ff;
    --card:#ffffff;
    --accent-1:#0a74ff;
    --accent-2:#00c6ff;
    --muted:#65748b;
    --radius:16px;
    --danger:#ff4d4f;
    --warn:#ffb020;
    --ok:#2ecc71;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:'Poppins',sans-serif;
    background: linear-gradient(180deg,var(--bg) 0%, #eef4ff 100%);
    color:#123;
    -webkit-font-smoothing:antialiased;
  }

  /* Header */
  header{
    display:flex; justify-content:space-between; align-items:center;
    padding:16px 28px; background:linear-gradient(90deg,var(--accent-1),var(--accent-2));
    color:white; position:sticky; top:0; z-index:60; box-shadow:0 6px 20px rgba(10,116,255,0.12)
  }
  header h1{font-size:1.1rem; margin:0}
  nav{display:flex; gap:14px}
  nav a{color:rgba(255,255,255,0.95); text-decoration:none; font-weight:500}
  nav a:hover{text-decoration:underline}

  /* Layout container */
  .container{max-width:1200px; margin:28px auto; padding:0 18px}

  /* Hero */
  .hero{
    display:grid; grid-template-columns:1fr 420px; gap:24px; align-items:center;
    background: linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.85));
    border-radius:var(--radius); padding:26px; box-shadow:0 8px 30px rgba(11,59,121,0.06);
  }
  .hero-left h2{font-size:1.9rem; color:var(--accent-1); margin:0 0 8px}
  .hero-left p{color:var(--muted); margin:0 0 14px}
  .hero-right .hero-image{width:100%; max-width:380px; border-radius:12px; overflow:hidden; box-shadow:0 14px 40px rgba(10,116,255,0.08)}
  .hero-right img{width:100%; display:block}

  .btn{
    display:inline-block; background:var(--accent-2); color:white; border:none; padding:10px 16px;
    border-radius:999px; font-weight:600; cursor:pointer; box-shadow:0 6px 18px rgba(0,198,255,0.12)
  }
  .btn.secondary{background:transparent; color:var(--accent-1); border:1px solid rgba(10,116,255,0.12)}

  /* Dashboard card */
  .dashboard{margin-top:22px; background:var(--card); border-radius:14px; padding:16px; box-shadow:0 8px 24px rgba(15,32,64,0.04)}
  .grid-3{display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-bottom:12px}
  .stat{background:linear-gradient(180deg,#fff,#fbfdff); border-radius:10px; padding:12px; min-height:86px}
  .stat h4{margin:0; color:var(--muted); font-size:0.9rem}
  .stat .value{font-size:1.5rem; font-weight:700; color:var(--accent-1)}

  .row{display:grid; grid-template-columns:300px 1fr; gap:12px; align-items:center}
  .gauges{background:linear-gradient(180deg,#fff,#f7fbff); padding:10px; border-radius:12px; display:flex; flex-direction:column; gap:10px}
  .gauge-row{display:flex; gap:10px; justify-content:center}
  .gauge{width:96px; height:96px; position:relative; display:flex; align-items:center; justify-content:center}
  .gauge canvas{position:absolute; left:0; top:0}
  .gLabel{position:relative; z-index:3; font-size:0.95rem; text-align:center}

  .chart-card{padding:10px; border-radius:12px; background:linear-gradient(180deg,#fff,#fbfdff)}
  .controls{display:flex; gap:8px; align-items:center; margin-top:10px}
  .small{font-size:0.9rem; color:var(--muted)}

  /* cards below */
  .card-section{display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-top:20px}
  .card{padding:14px; border-radius:12px; background:linear-gradient(180deg,#fff,#fbfdff); box-shadow:0 10px 30px rgba(11,59,121,0.04)}
  .card img{width:100%; border-radius:8px; margin-top:10px}

  /* about/contact */
  .two-col{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:18px}
  .contact form input, .contact form textarea{width:100%; padding:10px; border-radius:8px; border:1px solid #e6eefc; font-family:inherit}

  footer{margin-top:20px; padding:16px 0; color:var(--muted); text-align:center}

  /* Admin panel (floating) */
  .admin {
    position:fixed; right:18px; bottom:18px; width:320px; background:linear-gradient(180deg,#ffffff,#fbfdff);
    border-radius:12px; box-shadow:0 20px 60px rgba(10,116,255,0.12); padding:12px; z-index:120;
  }
  .admin h4{margin:0 0 8px 0; color:var(--accent-1)}
  .admin label{display:block; font-size:0.85rem; color:var(--muted); margin-top:8px}
  .admin input[type="number"], .admin input[type="text"]{width:100%; padding:8px; border-radius:8px; border:1px solid #e6eefc}
  .admin .row{display:flex; gap:8px}
  .admin .actions{display:flex; gap:8px; margin-top:10px}

  /* Alert banner */
  .alert-banner{
    position:fixed; left:50%; transform:translateX(-50%); top:18px; background:linear-gradient(90deg,#ff4d4f,#ff7a77);
    color:white; padding:10px 16px; border-radius:999px; display:none; z-index:140; box-shadow:0 12px 36px rgba(255,77,79,0.2)
  }
  .alert-banner.show{display:block}

  @media(max-width:1050px){
    .hero{grid-template-columns:1fr}
    .row{grid-template-columns:1fr}
    .grid-3{grid-template-columns:repeat(1,1fr)}
    .card-section{grid-template-columns:repeat(1,1fr)}
    .two-col{grid-template-columns:repeat(1,1fr)}
    .admin{position:static; width:auto; margin:12px}
  }
</style>
</head>
<body>

<header>
  <h1>IoT Health Monitor ‚Äî Professional Demo</h1>
  <nav>
    <a href="#home">Home</a>
    <a href="#dashboard">Dashboard</a>
    <a href="#doctor">Doctor</a>
    <a href="#gym">Gym</a>
    <a href="#about">About</a>
    <a href="#contact">Contact</a>
  </nav>
</header>

<div class="container">
  <!-- HERO -->
  <section id="home" class="hero" aria-labelledby="hero-title">
    <div class="hero-left">
      <h2 id="hero-title">Professional IoT Health Monitoring</h2>
      <p>Real-time BPM, temperature and humidity monitoring for clinics, gyms and product demos. Secure, responsive and easy to integrate with ThingSpeak.</p>
      <div style="margin-top:12px">
        <button class="btn" onclick="document.getElementById('dashboard').scrollIntoView({behavior:'smooth'})">Live Dashboard</button>
        <button class="btn secondary" onclick="downloadCSV()">Download CSV</button>
      </div>
    </div>

    <div class="hero-right">
      <div class="hero-image" aria-hidden="true">
        <!-- doctor + patient IoT image (Unsplash) -->
        <img src="https://images.unsplash.com/photo-1580281657528-9f0d1a4f7b3b?auto=format&fit=crop&w=900&q=80" alt="Doctor checking patient monitor">
      </div>
      <div style="text-align:center; font-size:0.86rem; color:var(--muted); margin-top:8px">Demo ‚Äî connect your ThingSpeak channel below to show live data</div>
    </div>
  </section>

  <!-- DASHBOARD -->
  <section id="dashboard" class="dashboard" aria-labelledby="dashboard-title">
    <h3 id="dashboard-title" style="margin:0 0 12px 0; color:var(--accent-1)">üìä Real-Time Dashboard</h3>

    <div class="grid-3" role="list">
      <div class="stat" role="listitem">
        <h4>‚ù§Ô∏è Heart Rate</h4>
        <div class="value" id="bpmValue">-- BPM</div>
        <div class="small">Latest reading</div>
      </div>

      <div class="stat" role="listitem">
        <h4>üå° Temperature</h4>
        <div class="value" id="tempValue">-- ¬∞C</div>
        <div class="small">Latest reading</div>
      </div>

      <div class="stat" role="listitem">
        <h4>üíß Humidity</h4>
        <div class="value" id="humValue">-- %</div>
        <div class="small">Latest reading</div>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <!-- Gauges -->
      <aside class="gauges" aria-label="Live gauges">
        <div style="font-weight:600; color:var(--muted); text-align:center">Live Gauges</div>
        <div class="gauge-row" role="group" aria-label="Gauges">
          <div class="gauge" title="BPM gauge">
            <canvas id="gaugeBPM" width="96" height="96"></canvas>
            <div class="gLabel" id="gLabelBPM">--</div>
          </div>

          <div class="gauge" title="Temperature gauge">
            <canvas id="gaugeTemp" width="96" height="96"></canvas>
            <div class="gLabel" id="gLabelTemp">--</div>
          </div>

          <div class="gauge" title="Humidity gauge">
            <canvas id="gaugeHum" width="96" height="96"></canvas>
            <div class="gLabel" id="gLabelHum">--</div>
          </div>
        </div>

        <div style="text-align:center; margin-top:8px" class="small">Auto-refresh every 10 seconds</div>
        <div style="text-align:center; margin-top:6px">
          <button class="btn secondary" onclick="refreshNow()">Refresh</button>
        </div>
      </aside>

      <!-- Chart -->
      <div class="chart-card">
        <canvas id="dataChart"></canvas>
        <div class="controls">
          <div class="small">Showing last <strong id="pointsCount">10</strong> readings</div>
          <div style="flex:1"></div>
          <button class="btn secondary" onclick="downloadCSV()">Download CSV</button>
        </div>
      </div>
    </div>
  </section>

  <!-- cards: doctor, gym, tips -->
  <section class="card-section" aria-label="Info">
    <div class="card">
      <h4>üë®‚Äç‚öïÔ∏è Doctor Monitoring</h4>
      <p style="color:var(--muted)">Remote vitals monitoring with alerting and CSV export for records. Fits telemedicine workflows.</p>
      <img src="https://images.unsplash.com/photo-1582735686895-ec9ca0dc5d7d?auto=format&fit=crop&w=1000&q=80" alt="Doctor with patient">
    </div>

    <div class="card">
      <h4>üèãÔ∏è‚Äç‚ôÇÔ∏è Gym Integration</h4>
      <p style="color:var(--muted)">Monitor members' BPM while training. Integrate wearables to ThingSpeak for group dashboards and safety alerts.</p>
      <img src="https://images.unsplash.com/photo-1517245386807-bb43f82c33c4?auto=format&fit=crop&w=1000&q=80" alt="Gym workout wearable">
    </div>

    <div class="card">
      <h4>üí° Health Tips</h4>
      <p style="color:var(--muted)">Use readings to personalize advice ‚Äî hydration, rest, training intensity. Export readings for coaches or clinicians.</p>
      <img src="https://images.unsplash.com/photo-1526256262350-7da7584cf5eb?auto=format&fit=crop&w=1000&q=80" alt="Health tips illustration">
    </div>
  </section>

  <!-- about + contact -->
  <div class="two-col">
    <div class="card">
      <h4>About this Demo</h4>
      <p style="color:var(--muted)">This demo shows how Arduino / NodeMCU sensors can publish BPM, temperature and humidity to ThingSpeak. The UI pulls the ThingSpeak read API to visualize live data and issue alerts when thresholds are exceeded.</p>
      <ul style="color:var(--muted); margin-top:8px">
        <li>Live line chart and medical-style gauges</li>
        <li>Admin panel to set thresholds (stored locally)</li>
        <li>CSV export of recent data</li>
      </ul>
    </div>

    <div class="card contact" id="contact">
      <h4>Contact / Demo Request</h4>
      <p style="color:var(--muted)">Email to schedule an integration or live demo.</p>
      <p><strong>Email:</strong> <a href="mailto:thapelomokoa.projects@gmail.com">thapelomokoa.projects@gmail.com</a></p>

      <form id="contactForm" onsubmit="submitContact(event)" style="margin-top:8px; display:flex; flex-direction:column; gap:8px">
        <input id="name" placeholder="Your name" required/>
        <input id="email" placeholder="Your email" required/>
        <textarea id="msg" placeholder="Message (optional)" rows="4"></textarea>
        <div style="display:flex; gap:8px">
          <button class="btn" type="submit">Send</button>
          <button type="button" class="btn secondary" onclick="document.getElementById('contactForm').reset()">Clear</button>
        </div>
        <div id="contactStatus" class="small" style="margin-top:4px"></div>
      </form>
    </div>
  </div>

  <footer>
    <p>Developed by <strong>Thapelo Mokoa</strong> ‚Äî IoT Health Monitoring Demo ¬© 2025</p>
  </footer>
</div>

<!-- ALERT BANNER -->
<div id="alertBanner" class="alert-banner" role="status" aria-live="assertive">
  ‚ö†Ô∏è Alert ‚Äî threshold exceeded
  <span id="alertActions" style="margin-left:12px"></span>
</div>

<!-- ADMIN PANEL (floating) -->
<div class="admin" aria-hidden="false">
  <h4>Admin ‚Äî Thresholds & Alerts</h4>

  <label>ThingSpeak Channel ID</label>
  <input id="cfgChannel" type="text" placeholder="e.g. 3128115">

  <label>ThingSpeak Read API Key</label>
  <input id="cfgKey" type="text" placeholder="Read API Key">

  <label>BPM high threshold (alert if >=)</label>
  <input id="thBPM" type="number" min="1" value="120">

  <label>Temperature high threshold ¬∞C (alert if >=)</label>
  <input id="thTemp" type="number" min="-10" value="38">

  <label>Humidity high threshold % (alert if >=)</label>
  <input id="thHum" type="number" min="0" max="100" value="85">

  <label>Alert email (optional)</label>
  <input id="alertEmail" type="text" placeholder="alerts@example.com">

  <label>Alert phone (optional, e.g. +27123456789)</label>
  <input id="alertPhone" type="text" placeholder="+27123456789">

  <div class="actions" style="margin-top:8px">
    <button class="btn" onclick="saveConfig()">Save</button>
    <button class="btn secondary" onclick="loadConfig()">Load</button>
    <button class="btn secondary" onclick="testAlert()">Send Test Alert</button>
  </div>

  <div style="margin-top:8px; font-size:0.85rem; color:var(--muted)">
    Notes:
    <ul style="margin:6px 0 0 18px">
      <li>Alerts open your mail client (mailto:) or SMS app (sms:) ‚Äî for server/email automation use a backend webhook.</li>
      <li>Admin settings are saved in your browser localStorage.</li>
    </ul>
  </div>
</div>

<script>
/* ---------------------------
   Configuration & persistence
   --------------------------- */
const DEFAULTS = {
  channelID: '3128115',
  apiKey: 'K72OYJMYOJZN240T',
  thBPM: 120,
  thTemp: 38,
  thHum: 85,
  alertEmail: '',
  alertPhone: ''
};

function saveConfig(){
  const cfg = {
    channelID: document.getElementById('cfgChannel').value.trim() || DEFAULTS.channelID,
    apiKey: document.getElementById('cfgKey').value.trim() || DEFAULTS.apiKey,
    thBPM: Number(document.getElementById('thBPM').value) || DEFAULTS.thBPM,
    thTemp: Number(document.getElementById('thTemp').value) || DEFAULTS.thTemp,
    thHum: Number(document.getElementById('thHum').value) || DEFAULTS.thHum,
    alertEmail: document.getElementById('alertEmail').value.trim(),
    alertPhone: document.getElementById('alertPhone').value.trim()
  };
  localStorage.setItem('iotCfg', JSON.stringify(cfg));
  applyConfig(cfg);
  alert('Settings saved locally.');
}

function loadConfig(){
  const raw = localStorage.getItem('iotCfg');
  if(!raw){
    applyConfig(DEFAULTS);
    // populate UI with defaults
    document.getElementById('cfgChannel').value = DEFAULTS.channelID;
    document.getElementById('cfgKey').value = DEFAULTS.apiKey;
    document.getElementById('thBPM').value = DEFAULTS.thBPM;
    document.getElementById('thTemp').value = DEFAULTS.thTemp;
    document.getElementById('thHum').value = DEFAULTS.thHum;
    document.getElementById('alertEmail').value = '';
    document.getElementById('alertPhone').value = '';
    return;
  }
  const cfg = JSON.parse(raw);
  document.getElementById('cfgChannel').value = cfg.channelID || DEFAULTS.channelID;
  document.getElementById('cfgKey').value = cfg.apiKey || DEFAULTS.apiKey;
  document.getElementById('thBPM').value = cfg.thBPM || DEFAULTS.thBPM;
  document.getElementById('thTemp').value = cfg.thTemp || DEFAULTS.thTemp;
  document.getElementById('thHum').value = cfg.thHum || DEFAULTS.thHum;
  document.getElementById('alertEmail').value = cfg.alertEmail || '';
  document.getElementById('alertPhone').value = cfg.alertPhone || '';
  applyConfig(cfg);
  alert('Loaded saved settings.');
}

function applyConfig(cfg){
  // global vars updated below
  window.CFG = cfg;
  // update points label
  document.getElementById('pointsCount').innerText = pointsToShow;
}

/* init default config on first load */
let saved = localStorage.getItem('iotCfg');
if(!saved){
  localStorage.setItem('iotCfg', JSON.stringify(DEFAULTS));
  saved = localStorage.getItem('iotCfg');
}
applyConfig(JSON.parse(saved));
loadConfig(); // populate UI with saved values

/* ---------------------------
   ThingSpeak & UI variables
   --------------------------- */
let channelID = () => (window.CFG && window.CFG.channelID) ? window.CFG.channelID : DEFAULTS.channelID;
let apiKey = () => (window.CFG && window.CFG.apiKey) ? window.CFG.apiKey : DEFAULTS.apiKey;
const pointsToShow = 12; // how many points to show (last N)
document.getElementById('pointsCount').innerText = pointsToShow;

/* small helper */
function toNumber(v){ const n = parseFloat(v); return isNaN(n) ? null : n; }

/* ---------------------------
   Gauges (doughnut) creation
   --------------------------- */
function createGauge(canvas, baseColor){
  const ctx = canvas.getContext('2d');
  return new Chart(ctx, {
    type:'doughnut',
    data:{
      labels:['value','rest'],
      datasets:[{
        data:[0,100],
        backgroundColor:[baseColor,'rgba(220,230,250,0.35)'],
        borderWidth:0
      }]
    },
    options:{
      rotation: -1.1 * Math.PI,
      circumference: 1.2 * Math.PI,
      cutout: '70%',
      plugins:{legend:{display:false}, tooltip:{enabled:false}},
      animation:{duration:600}
    }
  });
}

const gaugeBPM = createGauge(document.getElementById('gaugeBPM'),'rgba(255,80,80,0.95)');
const gaugeTemp = createGauge(document.getElementById('gaugeTemp'),'rgba(0,122,255,0.95)');
const gaugeHum = createGauge(document.getElementById('gaugeHum'),'rgba(0,200,160,0.95)');

/* ---------------------------
   Line chart for history
   --------------------------- */
const ctxLine = document.getElementById('dataChart').getContext('2d');
const lineChart = new Chart(ctxLine, {
  type:'line',
  data:{
    labels: [],
    datasets:[
      { label:'BPM', data:[], borderColor:'rgba(255,70,70,0.95)', backgroundColor:'rgba(255,70,70,0.06)', tension:0.25, pointRadius:2 },
      { label:'Temp (¬∞C)', data:[], borderColor:'rgba(0,120,255,0.95)', backgroundColor:'rgba(0,120,255,0.06)', tension:0.25, pointRadius:2 },
      { label:'Humidity (%)', data:[], borderColor:'rgba(0,180,160,0.95)', backgroundColor:'rgba(0,180,160,0.06)', tension:0.25, pointRadius:2 }
    ]
  },
  options:{
    responsive:true,
    plugins:{legend:{position:'bottom'}},
    scales:{
      x:{ display:true },
      y:{ display:true }
    }
  }
});

/* ---------------------------
   Alerts: rate-limited & actions
   --------------------------- */
let lastAlertTimes = { bpm:0, temp:0, hum:0 };
const ALERT_COOLDOWN_MS = 1000 * 60 * 3; // 3 minutes between repeated alerts per metric

function showAlert(message, metric, detail){
  const banner = document.getElementById('alertBanner');
  const actions = document.getElementById('alertActions');
  banner.classList.add('show');
  banner.textContent = '‚ö†Ô∏è ' + message + ' ';
  // add action buttons
  actions.innerHTML = '';
  const cfg = JSON.parse(localStorage.getItem('iotCfg') || JSON.stringify(DEFAULTS));

  // Email action
  const emailBtn = document.createElement('button');
  emailBtn.textContent = 'Send Alert Email';
  emailBtn.className = 'btn secondary';
  emailBtn.style.marginLeft = '10px';
  emailBtn.onclick = () => {
    const to = cfg.alertEmail || '';
    const subject = encodeURIComponent(`ALERT: ${metric.toUpperCase()} threshold exceeded`);
    const body = encodeURIComponent(`Alert details:\nMetric: ${metric}\nValue: ${detail.value}\nThreshold: ${detail.threshold}\nTime: ${new Date().toLocaleString()}\n\nPlease check the patient.`);
    if(!to) { alert('No alert email configured in admin panel.'); return; }
    window.location.href = `mailto:${to}?subject=${subject}&body=${body}`;
  };
  actions.appendChild(emailBtn);

  // SMS action
  const smsBtn = document.createElement('button');
  smsBtn.textContent = 'Send SMS';
  smsBtn.className = 'btn secondary';
  smsBtn.style.marginLeft = '8px';
  smsBtn.onclick = () => {
    const phone = cfg.alertPhone || '';
    const msg = encodeURIComponent(`ALERT: ${metric.toUpperCase()}=${detail.value} exceeded threshold ${detail.threshold} at ${new Date().toLocaleString()}`);
    if(!phone){ alert('No alert phone configured in admin panel.'); return; }
    // sms: scheme; may open phone SMS app on mobile
    window.location.href = `sms:${phone}?&body=${msg}`;
  };
  actions.appendChild(smsBtn);

  // Copy message button
  const copyBtn = document.createElement('button');
  copyBtn.textContent = 'Copy Message';
  copyBtn.className = 'btn secondary';
  copyBtn.style.marginLeft = '8px';
  copyBtn.onclick = () => {
    const text = `ALERT: ${metric.toUpperCase()}=${detail.value} exceeded threshold ${detail.threshold} at ${new Date().toLocaleString()}`;
    navigator.clipboard?.writeText(text).then(()=>alert('Copied alert message to clipboard'));
  };
  actions.appendChild(copyBtn);

  // Hide banner after 20s
  setTimeout(()=>{ banner.classList.remove('show'); actions.innerHTML=''; }, 20000);
}

/* Check thresholds and trigger alert if needed (rate-limited) */
function checkAndAlert(metric, value){
  const cfg = JSON.parse(localStorage.getItem('iotCfg') || JSON.stringify(DEFAULTS));
  const now = Date.now();
  if(metric === 'bpm'){
    const thr = Number(cfg.thBPM || DEFAULTS.thBPM);
    if(value !== null && value >= thr && now - lastAlertTimes.bpm > ALERT_COOLDOWN_MS){
      lastAlertTimes.bpm = now;
      showAlert(`Heart rate high (${value} BPM) ‚Äî exceeds ${thr} BPM`, 'bpm', {value, threshold: thr});
    }
  } else if(metric === 'temp'){
    const thr = Number(cfg.thTemp || DEFAULTS.thTemp);
    if(value !== null && value >= thr && now - lastAlertTimes.temp > ALERT_COOLDOWN_MS){
      lastAlertTimes.temp = now;
      showAlert(`Temperature high (${value} ¬∞C) ‚Äî exceeds ${thr} ¬∞C`, 'temp', {value, threshold: thr});
    }
  } else if(metric === 'hum'){
    const thr = Number(cfg.thHum || DEFAULTS.thHum);
    if(value !== null && value >= thr && now - lastAlertTimes.hum > ALERT_COOLDOWN_MS){
      lastAlertTimes.hum = now;
      showAlert(`Humidity high (${value} %) ‚Äî exceeds ${thr} %`, 'hum', {value, threshold: thr});
    }
  }
}

/* Manual test alert */
function testAlert(){
  const now = new Date().toLocaleString();
  showAlert(`TEST ALERT triggered at ${now}`, 'test', {value:'TEST', threshold:'N/A'});
}

/* ---------------------------
   Fetch data from ThingSpeak
   --------------------------- */
async function fetchDataAndUpdate(limit = pointsToShow){
  const url = `https://api.thingspeak.com/channels/${channelID()}/feeds.json?api_key=${apiKey()}&results=${limit}`;
  try{
    const resp = await fetch(url);
    if(!resp.ok) throw new Error('Network response was not ok');
    const data = await resp.json();
    const feeds = data.feeds || [];
    if(feeds.length === 0) return;

    // convert to arrays oldest->newest
    const times = feeds.map(f => new Date(f.created_at).toLocaleTimeString());
    const bpmArr = feeds.map(f => toNumber(f.field1));
    const tempArr = feeds.map(f => toNumber(f.field2));
    const humArr = feeds.map(f => toNumber(f.field3));

    const last = feeds[feeds.length - 1];
    const lastBPM = toNumber(last.field1);
    const lastTemp = toNumber(last.field2);
    const lastHum = toNumber(last.field3);

    // Update stat values
    document.getElementById('bpmValue').innerText = (lastBPM !== null) ? `${lastBPM} BPM` : '--';
    document.getElementById('tempValue').innerText = (lastTemp !== null) ? `${lastTemp} ¬∞C` : '--';
    document.getElementById('humValue').innerText = (lastHum !== null) ? `${lastHum} %` : '--';

    // Update gauges ‚Äî convert to percentage of expected maximums
    const bpmPct = lastBPM !== null ? Math.min(100, Math.round((lastBPM / 200) * 100)) : 0;
    const tempPct = lastTemp !== null ? Math.min(100, Math.round(((lastTemp + 10) / 60) * 100)) : 0; // scale temp roughly
    const humPct = lastHum !== null ? Math.min(100, Math.round((lastHum / 100) * 100)) : 0;

    // Color zones: determine color based on thresholds for each metric
    const cfg = JSON.parse(localStorage.getItem('iotCfg') || JSON.stringify(DEFAULTS));
    function chooseColor(metric, value){
      if(value===null) return 'rgba(180,180,190,0.95)';
      if(metric==='bpm'){
        const hi = Number(cfg.thBPM || DEFAULTS.thBPM);
        if(value >= hi) return 'rgba(255,70,70,0.95)'; // red
        if(value >= hi * 0.85) return 'rgba(255,170,60,0.95)'; // yellow
        return 'rgba(46,204,113,0.95)'; // green
      } else if(metric==='temp'){
        const hi = Number(cfg.thTemp || DEFAULTS.thTemp);
        if(value >= hi) return 'rgba(255,70,70,0.95)';
        if(value >= hi - 2) return 'rgba(255,170,60,0.95)';
        return 'rgba(0,120,255,0.95)';
      } else { // hum
        const hi = Number(cfg.thHum || DEFAULTS.thHum);
        if(value >= hi) return 'rgba(255,70,70,0.95)';
        if(value >= hi - 10) return 'rgba(255,170,60,0.95)';
        return 'rgba(0,180,160,0.95)';
      }
    }

    // update gauge colors and values
    gaugeBPM.data.datasets[0].backgroundColor[0] = chooseColor('bpm', lastBPM);
    gaugeBPM.data.datasets[0].data = [bpmPct, 100 - bpmPct];
    gaugeTemp.data.datasets[0].backgroundColor[0] = chooseColor('temp', lastTemp);
    gaugeTemp.data.datasets[0].data = [tempPct, 100 - tempPct];
    gaugeHum.data.datasets[0].backgroundColor[0] = chooseColor('hum', lastHum);
    gaugeHum.data.datasets[0].data = [humPct, 100 - humPct];

    gaugeBPM.update(); gaugeTemp.update(); gaugeHum.update();

    document.getElementById('gLabelBPM').innerText = lastBPM!==null ? `${lastBPM} BPM` : '--';
    document.getElementById('gLabelTemp').innerText = lastTemp!==null ? `${lastTemp} ¬∞C` : '--';
    document.getElementById('gLabelHum').innerText = lastHum!==null ? `${lastHum} %` : '--';

    // Update line chart
    lineChart.data.labels = times;
    lineChart.data.datasets[0].data = bpmArr;
    lineChart.data.datasets[1].data = tempArr;
    lineChart.data.datasets[2].data = humArr;
    lineChart.update();

    // Check thresholds and alert if needed
    checkAndAlert('bpm', lastBPM);
    checkAndAlert('temp', lastTemp);
    checkAndAlert('hum', lastHum);
  }catch(e){
    console.error('Fetch error', e);
  }
}

/* Auto refresh */
let autorefresh = setInterval(()=>fetchDataAndUpdate(pointsToShow), 10000);
fetchDataAndUpdate(pointsToShow);

/* Manual controls */
function refreshNow(){ fetchDataAndUpdate(pointsToShow); }

/* CSV download */
function downloadCSV(){
  const url = `https://api.thingspeak.com/channels/${channelID()}/feeds.json?api_key=${apiKey()}&results=50`;
  fetch(url).then(r=>r.json()).then(data=>{
    const feeds = data.feeds || [];
    let csv = 'created_at,BPM,Temperature,Humidity\n';
    feeds.forEach(f => {
      csv += `${f.created_at},${f.field1||''},${f.field2||''},${f.field3||''}\n`;
    });
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'thingspeak_health_data.csv';
    a.click();
  }).catch(e=>alert('Failed to download CSV: ' + e.message));
}

/* Contact form behavior */
function submitContact(e){
  e.preventDefault();
  const name = document.getElementById('name').value.trim();
  const email = document.getElementById('email').value.trim();
  const msg = document.getElementById('msg').value.trim();
  const status = document.getElementById('contactStatus');
  if(!name || !email){ status.innerText = 'Please provide name and email.'; return; }
  const subject = encodeURIComponent(`Demo request from ${name}`);
  const body = encodeURIComponent(`Name: ${name}\nEmail: ${email}\n\n${msg}`);
  window.location.href = `mailto:thapelomokoa.projects@gmail.com?subject=${subject}&body=${body}`;
  status.innerText = 'Opening mail client...';
}

/* On page unload, save current admin UI to localStorage so user doesn't lose changes */
window.addEventListener('beforeunload', ()=>{
  const cfg = {
    channelID: document.getElementById('cfgChannel').value.trim() || DEFAULTS.channelID,
    apiKey: document.getElementById('cfgKey').value.trim() || DEFAULTS.apiKey,
    thBPM: Number(document.getElementById('thBPM').value) || DEFAULTS.thBPM,
    thTemp: Number(document.getElementById('thTemp').value) || DEFAULTS.thTemp,
    thHum: Number(document.getElementById('thHum').value) || DEFAULTS.thHum,
    alertEmail: document.getElementById('alertEmail').value.trim(),
    alertPhone: document.getElementById('alertPhone').value.trim()
  };
  localStorage.setItem('iotCfg', JSON.stringify(cfg));
});

/* load UI with saved values if present */
(function populateAdminFromSaved(){
  const raw = localStorage.getItem('iotCfg');
  if(!raw) return;
  try{
    const cfg = JSON.parse(raw);
    document.getElementById('cfgChannel').value = cfg.channelID || DEFAULTS.channelID;
    document.getElementById('cfgKey').value = cfg.apiKey || DEFAULTS.apiKey;
    document.getElementById('thBPM').value = cfg.thBPM || DEFAULTS.thBPM;
    document.getElementById('thTemp').value = cfg.thTemp || DEFAULTS.thTemp;
    document.getElementById('thHum').value = cfg.thHum || DEFAULTS.thHum;
    document.getElementById('alertEmail').value = cfg.alertEmail || '';
    document.getElementById('alertPhone').value = cfg.alertPhone || '';
    applyConfig(cfg);
  }catch(e){ console.warn('Could not parse saved config'); }
})();
</script>
</body>
</html>
