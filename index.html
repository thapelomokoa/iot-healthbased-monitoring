<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>IoT-Based Health Monitoring System — Live Dashboard</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- html2canvas + jsPDF for PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- Minimal CSS: modern dark theme with neon accents -->
<style>
  :root{
    --bg:#07121a;
    --card:#0f2933;
    --muted:#9fb3bd;
    --accent:#00d1b2;
    --accent-2:#ff6b6b;
    --glass: rgba(255,255,255,0.04);
    --glass-2: rgba(255,255,255,0.02);
    --glass-border: rgba(255,255,255,0.04);
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
  body{margin:0;background:linear-gradient(180deg,#041018 0%, #07222b 100%);color:#e6f7f5;min-height:100vh}
  header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:transparent}
  .brand{display:flex;gap:12px;align-items:center}
  .brand img{width:52px;height:52px;border-radius:10px;object-fit:cover;border:2px solid rgba(255,255,255,0.06)}
  .brand h1{margin:0;font-size:18px;letter-spacing:0.2px}
  .brand p{margin:0;font-size:12px;color:var(--muted)}
  nav{display:flex;gap:8px;align-items:center}
  a.btn{padding:8px 12px;border-radius:8px;text-decoration:none;color:inherit;border:1px solid var(--glass-border);background:var(--glass);font-size:13px}
  a.btn.primary{background:linear-gradient(90deg,var(--accent),#00a88f);box-shadow:0 6px 20px rgba(0,209,178,0.12);border:none;color:#042422}
  main{max-width:1200px;margin:16px auto;padding:0 16px}
  .hero{display:grid;grid-template-columns:1fr 420px;gap:20px;align-items:center;padding:22px;border-radius:14px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03)}
  .hero h2{margin:0 0 8px 0}
  .hero p{color:var(--muted);margin:0 0 14px 0}
  .hero .cta{display:flex;gap:10px}
  .card{background:var(--card);border-radius:12px;padding:12px;border:1px solid var(--glass-border)}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-top:14px}
  .gaugeCanvas{height:160px}
  .gaugeValue{font-weight:700;font-size:20px;margin-top:8px}
  #combinedChart{height:320px}
  .controls{display:flex;gap:8px;align-items:center;margin-top:12px}
  .small{font-size:13px;color:var(--muted)}
  footer{text-align:center;color:var(--muted);margin:28px 0;font-size:13px}

  /* heartbeat animation */
  .heartWrap{display:flex;align-items:center;gap:12px;justify-content:center;flex-direction:column}
  .heart{
    width:110px;height:110px;border-radius:50%;background:radial-gradient(circle at 30% 30%, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
    display:flex;align-items:center;justify-content:center;position:relative;box-shadow:0 8px 30px rgba(0,0,0,0.4);
    border:1px solid rgba(255,255,255,0.03)
  }
  .heart .beat{
    width:36px;height:36px;background:linear-gradient(180deg,var(--accent-2),#ff3b5c);border-radius:8px;transform:rotate(20deg);
    box-shadow:0 10px 30px rgba(255,107,107,0.16), inset 0 -6px 14px rgba(255,20,20,0.05)
  }
  /* responsive */
  @media (max-width:980px){
    .hero{grid-template-columns:1fr; padding:16px}
    .grid{grid-template-columns:1fr}
  }
</style>
</head>
<body>

<header>
  <div class="brand">
    <img src="https://images.unsplash.com/photo-1580281657528-889c0f578a66?q=80&w=800&auto=format&fit=crop&s=8b7a6d4b4d6df5e6c9f3a1da5a5d0a6f" alt="doctor">
    <div>
      <h1>IoT-Based Health Monitoring System</h1>
      <p class="small">Real-time vitals | ThingSpeak live dashboard</p>
    </div>
  </div>

  <nav>
    <div id="statusDot" class="small" style="padding:6px 10px;border-radius:8px;background:rgba(0,0,0,0.15)">Status: <span id="deviceStatus" style="font-weight:700;color:var(--muted)">Checking...</span></div>
    <a class="btn" href="#dashboard">Dashboard</a>
    <a class="btn primary" href="#consult">Consult Doctor</a>
  </nav>
</header>

<main>
  <!-- HERO -->
  <section class="hero">
    <div>
      <div style="display:flex;gap:8px;align-items:center"><span style="background:linear-gradient(90deg,var(--accent),#008e7e);padding:6px 10px;border-radius:8px;font-weight:700;font-size:12px">Student Project</span><span class="small">IoT · Arduino · ESP8266 · ThingSpeak</span></div>
      <h2>Monitor patients remotely — live heart rate, temperature & humidity</h2>
      <p class="small">This dashboard reads your ThingSpeak channel in real-time and displays interactive visualisations. Perfect for remote monitoring, gym dashboards, and demonstrations for your project report.</p>

      <div class="cta" style="margin-top:12px">
        <a class="btn primary" href="#dashboard">Open Live Dashboard</a>
        <a class="btn" href="#about">About & Hardware</a>
      </div>

      <div style="margin-top:16px" class="small">
        <strong>ThingSpeak Channel:</strong> <span id="channelIdLabel">3128115</span> • Poll: <span id="pollLabel">13s</span> • Fields: BPM (1), Temp (2), Hum (3)
      </div>
    </div>

    <div style="display:flex;flex-direction:column;gap:12px;align-items:center">
      <div class="card" style="width:100%;text-align:center;padding:16px">
        <div class="small">Doctor monitoring preview</div>
        <img src="https://images.unsplash.com/photo-1494790108377-be9c29b29330?q=80&w=1200&auto=format&fit=crop&s=5e9b3f7f45c9b2f3e2f6f5e7b6dd7a34" style="width:100%;height:200px;object-fit:cover;border-radius:8px;margin-top:8px">
      </div>

      <div class="card" style="width:100%;padding:14px;display:flex;flex-direction:column;align-items:center">
        <div class="small">Use cases</div>
        <ul class="small" style="text-align:left;margin:8px 0">
          <li>Remote doctor monitoring</li>
          <li>Gym heart-rate dashboards</li>
          <li>Demonstration for final year project</li>
        </ul>
      </div>
    </div>
  </section>

  <!-- DASHBOARD -->
  <section id="dashboard" class="card" style="margin-top:18px;padding:14px">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0">Live Dashboard</h3>
      <div class="small">Channel: <strong id="channelLabel">3128115</strong></div>
    </div>

    <div class="grid" style="margin-top:14px">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="small">Heart Rate</div>
            <div class="gaugeValue" id="bpmVal">-- BPM</div>
          </div>
          <div class="heartWrap" style="width:120px">
            <div class="heart" id="heartAnim"><div class="beat"></div></div>
            <div class="small">Live BPM</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="small">Temperature</div>
            <div class="gaugeValue" id="tempVal">-- °C</div>
          </div>
          <div style="width:120px">
            <canvas id="tempMini"></canvas>
          </div>
        </div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="small">Humidity</div>
            <div class="gaugeValue" id="humVal">-- %</div>
          </div>
          <div style="width:120px">
            <canvas id="humMini"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:14px;padding:12px">
      <h5 style="margin:0 0 10px 0">Combined recent (last readings)</h5>
      <canvas id="combinedChart"></canvas>
      <div class="controls">
        <button id="downloadCSV" class="btn">Download CSV</button>
        <button id="exportPDF" class="btn primary">Export PDF</button>
        <div style="flex:1"></div>
        <div class="small">Last update: <span id="lastUpdate">-</span></div>
      </div>
    </div>
  </section>

  <!-- ABOUT / HARDWARE -->
  <section id="about" class="card" style="margin-top:18px;padding:14px">
    <h3>About & Hardware</h3>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
      <div>
        <h5>Hardware used</h5>
        <ul class="small">
          <li>Arduino UNO — reads DHT22 and Pulse Sensor</li>
          <li>NodeMCU (ESP8266) — forwards data to ThingSpeak</li>
          <li>DHT22 — Temperature & Humidity</li>
          <li>Pulse sensor — Heart rate (analog)</li>
          <li>LCD 16x2 and LED — local display & heartbeat blink</li>
        </ul>
        <p class="small">Wiring summary: DHT22 data → Arduino D8 (with 10k pull-up to VCC). Pulse sensor signal → A0. Arduino TX/RX → NodeMCU RX/TX (common ground). NodeMCU uploads to ThingSpeak.</p>
      </div>
      <div>
        <img src="https://images.unsplash.com/photo-1581093588401-8a3c3b48b6a3?q=80&w=1200&auto=format&fit=crop&s=89f6ab8b9b3f7e1a2d7f0b6f2c4c9a6e" style="width:100%;height:220px;object-fit:cover;border-radius:8px">
      </div>
    </div>
  </section>

  <!-- CONSULT FORM -->
  <section id="consult" class="card" style="margin-top:18px;padding:14px">
    <h3>Consult Doctor</h3>
    <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:10px">
      <div style="flex:1;min-width:320px">
        <form id="consultForm">
          <div style="display:flex;gap:8px;margin-bottom:8px">
            <input id="cf_name" placeholder="Full name" class="card" style="flex:1;padding:10px;border-radius:8px;border:0"/>
            <input id="cf_email" type="email" placeholder="Email" class="card" style="width:220px;padding:10px;border-radius:8px;border:0"/>
          </div>
          <textarea id="cf_message" placeholder="Describe symptoms / notes" class="card" style="width:100%;height:120px;padding:10px;border-radius:8px;border:0"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="cf_channel" placeholder="ThingSpeak Channel (optional)" class="card" style="padding:10px;border-radius:8px;border:0"/>
            <button type="submit" class="btn primary">Send Request</button>
            <div id="consultStatus" class="small" style="align-self:center"></div>
          </div>
        </form>
      </div>
      <div style="width:320px">
        <div class="card" style="padding:12px">
          <h6>How it works</h6>
          <ol class="small">
            <li>Arduino reads sensors and computes BPM.</li>
            <li>NodeMCU uploads to ThingSpeak (write key stored on NodeMCU only).</li>
            <li>This website reads ThingSpeak read API and visualises data.</li>
          </ol>
        </div>
      </div>
    </div>
  </section>

  <footer>© 2025 Thapelo Mokoa — IoT-Based Health Monitoring System</footer>
</main>

<!-- ========== SCRIPTS ========== -->
<script>
/* ================= CONFIG =================
   Don't store ThingSpeak WRITE keys here. This file reads only (readKey).
   Channel and readKey provided by you:
*/
const CHANNEL_ID = '3128115';
const READ_KEY = 'K72OYJMYOJZN240T';
const POLL_MS = 13000; // 13 seconds
const FIELD_BPM = 'field1';    // BPM
const FIELD_TEMP = 'field2';   // Temperature
const FIELD_HUM = 'field3';    // Humidity

document.getElementById('channelLabel').innerText = CHANNEL_ID;
document.getElementById('channelIdLabel').innerText = CHANNEL_ID;
document.getElementById('pollLabel').innerText = (POLL_MS/1000) + 's';

/* ========== Chart & UI setup ========== */
const combinedCtx = document.getElementById('combinedChart').getContext('2d');
const combinedChart = new Chart(combinedCtx, {
  type: 'line',
  data: { labels: [], datasets: [
    { label: 'BPM', data: [], borderColor: '#ff6b6b', tension:0.2, pointRadius:2 },
    { label: 'Temperature (°C)', data: [], borderColor: '#ffb86b', tension:0.2, pointRadius:2 },
    { label: 'Humidity (%)', data: [], borderColor: '#6bd1ff', tension:0.2, pointRadius:2 },
  ]},
  options: { responsive:true, interaction:{mode:'index',intersect:false}, scales:{y:{beginAtZero:false}} }
});

// small mini charts
const tempMini = new Chart(document.getElementById('tempMini').getContext('2d'), { type:'doughnut', data:{datasets:[{data:[0,50],backgroundColor:['#ffb86b','#12292c']}]}, options:{rotation:Math.PI,circumference:Math.PI,cutout:'70%',plugins:{legend:{display:false}}} });
const humMini = new Chart(document.getElementById('humMini').getContext('2d'), { type:'doughnut', data:{datasets:[{data:[0,100],backgroundColor:['#6bd1ff','#07121a']}]}, options:{rotation:Math.PI,circumference:Math.PI,cutout:'70%',plugins:{legend:{display:false}}} });

/* heartbeat element */
const heartBeatEl = document.querySelector('#heartAnim .beat');
let lastFeeds = [];

/* Fetch from ThingSpeak */
async function fetchFeeds(limit=60) {
  const keyParam = READ_KEY ? `&api_key=${READ_KEY}` : '';
  const url = `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?results=${limit}${keyParam}`;
  const r = await fetch(url);
  if(!r.ok) throw new Error('ThingSpeak error ' + r.status);
  const j = await r.json();
  return j;
}

function parseFeeds(json) {
  const feeds = json.feeds || [];
  // arrays
  const labels = feeds.map(f => new Date(f.created_at).toLocaleTimeString());
  const bpm = feeds.map(f => { const v = parseFloat(f[FIELD_BPM]); return isNaN(v) ? 0 : v; });
  const temp = feeds.map(f => { const v = parseFloat(f[FIELD_TEMP]); return isNaN(v) ? 0 : v; });
  const hum = feeds.map(f => { const v = parseFloat(f[FIELD_HUM]); return isNaN(v) ? 0 : v; });
  return { feeds, labels, bpm, temp, hum };
}

function updateUI(parsed) {
  const { feeds, labels, bpm, temp, hum } = parsed;
  lastFeeds = feeds;
  const lastBPM = bpm.at(-1) || 0;
  const lastTemp = temp.at(-1) || 0;
  const lastHum = hum.at(-1) || 0;

  document.getElementById('bpmVal').innerText = (lastBPM>0? lastBPM:'--') + ' BPM';
  document.getElementById('tempVal').innerText = (lastTemp>0? lastTemp:'--') + ' °C';
  document.getElementById('humVal').innerText = (lastHum>0? lastHum:'--') + ' %';

  // update mini charts
  tempMini.data.datasets[0].data[0] = lastTemp; tempMini.data.datasets[0].data[1] = Math.max(0,50-lastTemp); tempMini.update();
  humMini.data.datasets[0].data[0] = lastHum; humMini.data.datasets[0].data[1] = Math.max(0,100-lastHum); humMini.update();

  // combined chart
  combinedChart.data.labels = labels;
  combinedChart.data.datasets[0].data = bpm;
  combinedChart.data.datasets[1].data = temp;
  combinedChart.data.datasets[2].data = hum;
  combinedChart.update();

  // last update time
  const lastTime = feeds.at(-1) ? new Date(feeds.at(-1).created_at) : null;
  document.getElementById('lastUpdate').innerText = lastTime ? lastTime.toLocaleString() : '-';

  // heartbeat: scale the beat with BPM (convert to ms animation)
  animateHeart(lastBPM);
}

/* heartbeat pulse animation */
let heartInterval = null;
function animateHeart(bpm) {
  const beatEl = document.querySelector('#heartAnim .beat');
  if(!beatEl) return;
  if(!bpm || bpm <= 0) {
    // gentle slow
    beatEl.style.transform = 'scale(1) rotate(20deg)';
    if(heartInterval){ clearInterval(heartInterval); heartInterval = null; }
    return;
  }
  const msPerBeat = 60000 / bpm; // ms between beats
  // small transform per beat
  if(heartInterval) clearInterval(heartInterval);
  (function beatOnce(){
    beatEl.animate([{ transform:'scale(1) rotate(20deg)' }, { transform:'scale(1.35) rotate(20deg)' }, { transform:'scale(1) rotate(20deg)' }], { duration: Math.max(200, msPerBeat/1.8), iterations: 1 });
  })();
  heartInterval = setInterval(()=> {
    beatEl.animate([{ transform:'scale(1) rotate(20deg)' }, { transform:'scale(1.35) rotate(20deg)' }, { transform:'scale(1) rotate(20deg)' }], { duration: Math.max(200, msPerBeat/1.8), iterations: 1 });
  }, Math.max(300, msPerBeat));
}

/* offline detection + status */
function updateStatus(feeds) {
  const statusEl = document.getElementById('deviceStatus');
  const now = Date.now();
  const last = feeds.at(-1) ? new Date(feeds.at(-1).created_at).getTime() : 0;
  if(!last) {
    statusEl.innerText = 'No data';
    statusEl.style.color = '#f0a500';
    return;
  }
  const delta = (now - last) / 1000;
  if(delta > 75) {
    statusEl.innerText = 'Offline';
    statusEl.style.color = '#ff6b6b';
  } else {
    statusEl.innerText = 'Online';
    statusEl.style.color = '#6bffcf';
  }
}

/* main refresh loop */
async function refresh() {
  try {
    const json = await fetchFeeds(300);
    const parsed = parseFeeds(json);
    updateUI(parsed);
    updateStatus(parsed.feeds);
  } catch (err) {
    console.error('refresh error', err);
    document.getElementById('deviceStatus').innerText = 'Error';
    document.getElementById('deviceStatus').style.color = '#ff6b6b';
  }
}

refresh();
setInterval(refresh, POLL_MS);

/* CSV export */
document.getElementById('downloadCSV').addEventListener('click', () => {
  if(!lastFeeds || !lastFeeds.length){ alert('No data yet'); return; }
  let csv = 'time,BPM,Temperature,Humidity\n';
  lastFeeds.forEach(f => {
    csv += `"${f.created_at}",${f[FIELD_BPM]||''},${f[FIELD_TEMP]||''},${f[FIELD_HUM]||''}\n`;
  });
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `thingspeak_channel_${CHANNEL_ID}.csv`; a.click();
});

/* PDF export (capture dashboard area) */
document.getElementById('exportPDF').addEventListener('click', async () => {
  const el = document.querySelector('#dashboard');
  const canvas = await html2canvas(el, { scale:1.2 });
  const img = canvas.toDataURL('image/png');
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('l','pt','a4');
  const w = pdf.internal.pageSize.getWidth();
  const h = pdf.internal.pageSize.getHeight();
  pdf.addImage(img,'PNG',0,0,w,h);
  pdf.save(`report_channel_${CHANNEL_ID}.pdf`);
});

/* Consult form: optional Google Apps Script integration
   If you deploy a Google Apps Script and provide the WebApp URL, set SCRIPT_URL variable below
*/
const SCRIPT_URL = ''; // <-- paste deployed Apps Script Web App URL here (optional)

document.getElementById('consultForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const name = document.getElementById('cf_name').value.trim();
  const email = document.getElementById('cf_email').value.trim();
  const msg = document.getElementById('cf_message').value.trim();
  const channel = document.getElementById('cf_channel').value.trim() || CHANNEL_ID;
  const status = document.getElementById('consultStatus');

  if(!SCRIPT_URL) { status.innerText = 'Deploy Google Apps Script and set SCRIPT_URL to enable this feature.'; status.style.color = '#f0a500'; return; }
  status.innerText = 'Sending...';
  try {
    const res = await fetch(SCRIPT_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name,email,channel,message:msg})});
    if(res.ok) { status.innerText = 'Request sent.'; status.style.color = '#6bffcf'; document.getElementById('consultForm').reset(); }
    else { status.innerText = 'Send failed'; status.style.color = '#ff6b6b'; }
  } catch(err){ status.innerText = 'Error sending'; status.style.color = '#ff6b6b'; console.error(err); }
});

/* small helper: show console instructions */
console.log('Dashboard loaded. ThingSpeak channel:', CHANNEL_ID, 'readKey:', '***hidden***');
</script>
</body>
</html>
