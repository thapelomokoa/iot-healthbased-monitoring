<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IoT Health Monitoring Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gaugeJS/dist/gauge.min.js"></script>
  <style>
    body.dark {
      background-color: #1e293b;
      color: #f8fafc;
    }
    body.dark header, body.dark footer {
      background-color: #0f172a;
    }
    body.dark .card {
      background-color: #334155;
      color: #f1f5f9;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-900 transition-colors duration-500">

  <header class="bg-blue-600 text-white py-5 shadow-lg text-center">
    <h1 class="text-3xl font-bold">IoT Health Monitoring Dashboard</h1>
    <p class="text-sm">Real-Time Monitoring via ThingSpeak</p>
  </header>

  <div class="flex justify-center mt-4">
    <button id="themeToggle" class="bg-gray-800 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition">
      ðŸŒ™ Toggle Dark/Light Mode
    </button>
  </div>

  <!-- Gauges Section -->
  <main class="p-6 grid grid-cols-1 md:grid-cols-3 gap-6">
    <div class="card shadow-lg rounded-2xl p-4 text-center transform hover:scale-105 transition duration-300">
      <h2 class="text-xl font-semibold mb-2">Body Temperature (Â°C)</h2>
      <canvas id="tempGauge" width="200" height="200"></canvas>
      <p id="tempValue" class="text-lg font-bold mt-2 text-blue-700">-- Â°C</p>
    </div>
    <div class="card shadow-lg rounded-2xl p-4 text-center transform hover:scale-105 transition duration-300">
      <h2 class="text-xl font-semibold mb-2">Heart Rate (BPM)</h2>
      <canvas id="pulseGauge" width="200" height="200"></canvas>
      <p id="pulseValue" class="text-lg font-bold mt-2 text-red-700">-- BPM</p>
    </div>
    <div class="card shadow-lg rounded-2xl p-4 text-center transform hover:scale-105 transition duration-300">
      <h2 class="text-xl font-semibold mb-2">Humidity (%)</h2>
      <canvas id="humidityGauge" width="200" height="200"></canvas>
      <p id="humidityValue" class="text-lg font-bold mt-2 text-green-700">-- %</p>
    </div>
  </main>

  <!-- Combined 24-Hour Trend Chart -->
  <section class="mx-6 mb-6 p-6">
    <div class="card p-4 rounded-2xl shadow-lg">
      <h2 class="text-2xl font-semibold mb-3 text-center">Last 24 Hours - Temperature, Heart Rate & Humidity</h2>
      <canvas id="combinedChart"></canvas>
    </div>
  </section>

  <!-- CSV Download -->
  <div class="text-center pb-8">
    <button id="downloadBtn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
      Download Data (CSV)
    </button>
  </div>

  <footer class="bg-gray-900 text-white text-center py-4">
    <p>Â© 2025 Thapelo Mokoa | IoT Health Monitoring Project</p>
  </footer>

  <script>
    const channelID = 3128115;
    const apiKey = "KAUQ35X9SMMOAML8";
    const readURL = `https://api.thingspeak.com/channels/${channelID}/feeds.json?api_key=${apiKey}&results=800`;

    let tempGauge, pulseGauge, humidityGauge;
    let combinedChart;

    function createGauge(id, color, min, max, isPulse=false){
      const opts = { 
        angle:0, lineWidth:0.3, radiusScale:1, 
        pointer:{length:0.6, strokeWidth:0.035, color:'#000'}, 
        limitMax:false, limitMin:false, colorStart:color, colorStop:color, strokeColor:'#eee', generateGradient:true, highDpiSupport:true, animationSpeed:32 
      };
      const g = new Gauge(document.getElementById(id)).setOptions(opts);
      g.maxValue = max; g.setMinValue(min); g.set(0); 

      if(isPulse){
        let scale = 1, up=true;
        setInterval(()=>{
          const canvas = document.getElementById(id);
          canvas.style.transform = `scale(${scale})`;
          if(up){ scale += 0.01; if(scale>=1.08) up=false; }
          else{ scale -= 0.01; if(scale<=1) up=true; }
        }, 30);
      }

      return g;
    }

    function setupCombinedChart(){
      const ctx = document.getElementById('combinedChart').getContext('2d');
      combinedChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            { label:'Temperature (Â°C)', data:[], borderColor:'blue', fill:false, yAxisID:'yTemp' },
            { label:'Heart Rate (BPM)', data:[], borderColor:'red', fill:false, yAxisID:'yBPM' },
            { label:'Humidity (%)', data:[], borderColor:'green', fill:false, yAxisID:'yHum' }
          ]
        },
        options: {
          responsive: true,
          animation: { duration: 0 },
          interaction: { mode: 'index', intersect: false },
          plugins: {
            tooltip: {
              enabled: true,
              mode: 'index',
              intersect: false,
              callbacks: {
                label: function(context){
                  let label = context.dataset.label || '';
                  let value = context.parsed.y !== null ? context.parsed.y : '--';
                  return label + ': ' + value.toFixed(1);
                }
              }
            }
          },
          scales:{
            yTemp: { type:'linear', position:'left', beginAtZero:true, title:{display:true,text:'Temperature (Â°C)'} },
            yBPM: { type:'linear', position:'right', beginAtZero:true, title:{display:true,text:'Heart Rate (BPM)'} },
            yHum: { type:'linear', position:'right', beginAtZero:true, grid:{drawOnChartArea:false}, title:{display:true,text:'Humidity (%)'} }
          }
        }
      });
    }

    async function fetchData(){
      try{
        const res = await fetch(readURL);
        const data = await res.json();
        const feeds = data.feeds;

        if(feeds.length>0){
          const now = new Date();
          const twentyFourHoursAgo = new Date(now.getTime() - 24*60*60*1000);

          const last24Feeds = feeds.filter(f => new Date(f.created_at) >= twentyFourHoursAgo);

          if(last24Feeds.length>0){
            const latest = last24Feeds[last24Feeds.length-1];
            const temp = parseFloat(latest.field1)||0;
            const pulse = parseFloat(latest.field2)||0;
            const hum = parseFloat(latest.field3)||0;

            document.getElementById('tempValue').textContent = `${temp.toFixed(1)} Â°C`;
            document.getElementById('pulseValue').textContent = `${pulse.toFixed(0)} BPM`;
            document.getElementById('humidityValue').textContent = `${hum.toFixed(1)} %`;

            const tempValues = last24Feeds.map(f=>parseFloat(f.field1)||0);
            const pulseValues = last24Feeds.map(f=>parseFloat(f.field2)||0);
            const humValues = last24Feeds.map(f=>parseFloat(f.field3)||0);

            const tempMax = Math.max(...tempValues, 50);
            const tempMin = Math.min(...tempValues, 0);
            tempGauge.maxValue = tempMax; tempGauge.setMinValue(tempMin);
            tempGauge.set(temp);

            const pulseMax = Math.max(...pulseValues, 180);
            const pulseMin = Math.min(...pulseValues, 40);
            pulseGauge.maxValue = pulseMax; pulseGauge.setMinValue(pulseMin);
            pulseGauge.set(pulse);

            const humMax = Math.max(...humValues, 100);
            const humMin = Math.min(...humValues, 0);
            humidityGauge.maxValue = humMax; humidityGauge.setMinValue(humMin);
            humidityGauge.set(hum);

            combinedChart.data.labels = last24Feeds.map(f => new Date(f.created_at).toLocaleTimeString());
            combinedChart.data.datasets[0].data = tempValues;
            combinedChart.data.datasets[1].data = pulseValues;
            combinedChart.data.datasets[2].data = humValues;
            combinedChart.update();
          }
        }
      } catch(e){ console.error(e); }
    }

    function downloadCSV(){
      fetch(readURL)
      .then(res => res.json())
      .then(data => {
        const feeds = data.feeds;
        const rows = feeds.map(f=>[f.created_at,f.field1,f.field2,f.field3]);
        let csv = 'Time,Temperature (Â°C),BPM,Humidity (%)\n'+rows.map(r=>r.join(',')).join('\n');
        const blob = new Blob([csv],{type:'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'health_data.csv'; a.click();
      });
    }

    document.getElementById('downloadBtn').addEventListener('click', downloadCSV);
    document.getElementById('themeToggle').addEventListener('click', ()=>document.body.classList.toggle('dark'));

    // Initialize gauges and chart
    tempGauge = createGauge('tempGauge','#ff9800',0,50);
    pulseGauge = createGauge('pulseGauge','#f44336',40,180,true);
    humidityGauge = createGauge('humidityGauge','#03a9f4',0,100);
    setupCombinedChart();

    // Fetch every 15 seconds
    fetchData();
    setInterval(fetchData,15000);
  </script>

</body>
</html>
