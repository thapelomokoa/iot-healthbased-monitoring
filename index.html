<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IoT Health Monitoring Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gaugeJS/dist/gauge.min.js"></script>
  <style>
    body.dark {
      background-color: #1e293b;
      color: #f8fafc;
    }
    body.dark header, body.dark footer {
      background-color: #0f172a;
    }
    body.dark .card {
      background-color: #334155;
      color: #f1f5f9;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-900 transition-colors duration-500">

  <header class="bg-blue-600 text-white py-5 shadow-lg text-center">
    <h1 class="text-3xl font-bold">IoT Health Monitoring Dashboard</h1>
    <p class="text-sm">Real-Time Monitoring via ThingSpeak</p>
  </header>

  <div class="flex justify-center mt-4">
    <button id="themeToggle" class="bg-gray-800 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition">
      ðŸŒ™ Toggle Dark/Light Mode
    </button>
  </div>

  <!-- Gauges Section -->
  <main class="p-6 grid grid-cols-1 md:grid-cols-3 gap-6">
    <!-- Temperature -->
    <div class="card shadow-lg rounded-2xl p-4 text-center transform hover:scale-105 transition duration-300">
      <h2 class="text-xl font-semibold mb-2">Body Temperature (Â°C)</h2>
      <canvas id="tempGauge" width="200" height="200"></canvas>
      <p id="tempValue" class="text-lg font-bold mt-2 text-blue-700">-- Â°C</p>
    </div>
    <!-- Heart Rate -->
    <div class="card shadow-lg rounded-2xl p-4 text-center transform hover:scale-105 transition duration-300">
      <h2 class="text-xl font-semibold mb-2">Heart Rate (BPM)</h2>
      <canvas id="pulseGauge" width="200" height="200"></canvas>
      <p id="pulseValue" class="text-lg font-bold mt-2 text-red-700">-- BPM</p>
    </div>
    <!-- Humidity -->
    <div class="card shadow-lg rounded-2xl p-4 text-center transform hover:scale-105 transition duration-300">
      <h2 class="text-xl font-semibold mb-2">Humidity (%)</h2>
      <canvas id="humidityGauge" width="200" height="200"></canvas>
      <p id="humidityValue" class="text-lg font-bold mt-2 text-green-700">-- %</p>
    </div>
  </main>

  <!-- Live Trend Charts -->
  <section class="mx-6 mb-6 p-6 grid grid-cols-1 md:grid-cols-1 gap-6">
    <div class="card p-4 rounded-2xl shadow-lg">
      <h2 class="text-2xl font-semibold mb-3 text-center">Temperature - Last 24 Hours</h2>
      <canvas id="tempChart"></canvas>
    </div>
    <div class="card p-4 rounded-2xl shadow-lg">
      <h2 class="text-2xl font-semibold mb-3 text-center">Heart Rate - Last 24 Hours</h2>
      <canvas id="pulseChart"></canvas>
    </div>
    <div class="card p-4 rounded-2xl shadow-lg">
      <h2 class="text-2xl font-semibold mb-3 text-center">Humidity - Last 24 Hours</h2>
      <canvas id="humidityChart"></canvas>
    </div>
  </section>

  <!-- CSV Download -->
  <div class="text-center pb-8">
    <button id="downloadBtn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
      Download Data (CSV)
    </button>
  </div>

  <footer class="bg-gray-900 text-white text-center py-4">
    <p>Â© 2025 Thapelo Mokoa | IoT Health Monitoring Project</p>
  </footer>

  <script>
    const channelID = 3128115;
    const apiKey = "KAUQ35X9SMMOAML8";
    const readURL = `https://api.thingspeak.com/channels/${channelID}/feeds.json?api_key=${apiKey}&results=50`;

    let tempGauge, pulseGauge, humidityGauge;
    let tempChart, pulseChart, humidityChart;

    function createGauge(id, color, min, max, isPulse=false){
      const opts = { 
        angle:0, lineWidth:0.3, radiusScale:1, 
        pointer:{length:0.6, strokeWidth:0.035, color:'#000'}, 
        limitMax:false, limitMin:false, colorStart:color, colorStop:color, strokeColor:'#eee', generateGradient:true, highDpiSupport:true, animationSpeed:32 
      };
      const g = new Gauge(document.getElementById(id)).setOptions(opts);
      g.maxValue = max; g.setMinValue(min); g.set(0); 

      // Pulse effect for heart rate
      if(isPulse){
        let scale = 1, up=true;
        setInterval(()=>{
          const canvas = document.getElementById(id);
          canvas.style.transform = `scale(${scale})`;
          if(up){ scale += 0.01; if(scale>=1.08) up=false; }
          else{ scale -= 0.01; if(scale<=1) up=true; }
        }, 30);
      }

      return g;
    }

    function setupCharts(){
      const tempCtx = document.getElementById('tempChart').getContext('2d');
      const pulseCtx = document.getElementById('pulseChart').getContext('2d');
      const humCtx = document.getElementById('humidityChart').getContext('2d');

      tempChart = new Chart(tempCtx, {type:'line', data:{labels:[], datasets:[{label:'Temperature (Â°C)',data:[],borderColor:'blue',fill:false}]}, options:{responsive:true, scales:{y:{beginAtZero:true}}, animation:{duration:0}}});
      pulseChart = new Chart(pulseCtx, {type:'line', data:{labels:[], datasets:[{label:'Heart Rate (BPM)',data:[],borderColor:'red',fill:false}]}, options:{responsive:true, scales:{y:{beginAtZero:true}}, animation:{duration:0}}});
      humidityChart = new Chart(humCtx, {type:'line', data:{labels:[], datasets:[{label:'Humidity (%)',data:[],borderColor:'green',fill:false}]}, options:{responsive:true, scales:{y:{beginAtZero:true}}, animation:{duration:0}}});
    }

    async function fetchData(){
      try{
        const res = await fetch(readURL);
        const data = await res.json();
        const feeds = data.feeds;
        if(feeds.length>0){
          const latest = feeds[feeds.length-1];
          const temp = parseFloat(latest.field1)||0;
          const pulse = parseFloat(latest.field2)||0;
          const hum = parseFloat(latest.field3)||0;

          document.getElementById('tempValue').textContent = `${temp.toFixed(1)} Â°C`;
          document.getElementById('pulseValue').textContent = `${pulse.toFixed(0)} BPM`;
          document.getElementById('humidityValue').textContent = `${hum.toFixed(1)} %`;

          tempGauge.set(temp); pulseGauge.set(pulse); humidityGauge.set(hum);

          const timeLabel = new Date(latest.created_at).toLocaleTimeString();
          tempChart.data.labels.push(timeLabel); tempChart.data.datasets[0].data.push(temp);
          pulseChart.data.labels.push(timeLabel); pulseChart.data.datasets[0].data.push(pulse);
          humidityChart.data.labels.push(timeLabel); humidityChart.data.datasets[0].data.push(hum);

          [tempChart, pulseChart, humidityChart].forEach(c=>{
            if(c.data.labels.length>50){ c.data.labels.shift(); c.data.datasets[0].data.shift(); }
            c.update();
          });
        }
      }catch(e){console.error("Error fetching data:",e);}
    }

    document.getElementById("downloadBtn").addEventListener("click", async ()=>{
      const res = await fetch(readURL); const data = await res.json();
      let csv="Time,Temperature,HeartRate,Humidity\n";
      data.feeds.forEach(f=>{ csv+=`${f.created_at},${f.field1},${f.field2},${f.field3}\n`; });
      const blob = new Blob([csv], {type:"text/csv"}); const url=URL.createObjectURL(blob);
      const a=document.createElement("a"); a.href=url; a.download="IoT_Health_Data.csv"; a.click();
    });

    document.getElementById('themeToggle').addEventListener('click',()=>{document.body.classList.toggle('dark');});

    window.onload=function(){
      tempGauge = createGauge("tempGauge","blue",0,50);
      pulseGauge = createGauge("pulseGauge","red",0,150,true); // heartbeat pulse effect
      humidityGauge = createGauge("humidityGauge","green",0,100);
      setupCharts();
      fetchData();
      setInterval(fetchData,15000);
    };
  </script>
</body>
</html>
