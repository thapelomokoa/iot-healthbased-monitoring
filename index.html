<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IoT Health Monitoring Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gaugeJS/dist/gauge.min.js"></script>
<style>
body { font-family: Arial, sans-serif; background: #f0f2f5; margin:0; padding:0; }
header { background:#4caf50; color:white; text-align:center; padding:1em; }
section { display:flex; flex-wrap:wrap; justify-content:space-around; margin:1em; }
.card { background:white; padding:1em; margin:1em; border-radius:10px; box-shadow:0 4px 8px rgba(0,0,0,0.1); flex:1 1 300px; }
h3 { margin-top:0; }
canvas { max-width:100%; height:300px; }
#gauges { display:flex; justify-content:space-around; flex-wrap:wrap; }
.gauge-card { flex:1 1 200px; text-align:center; margin:1em; }
button { background:#4caf50; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; margin-top:10px; }
button:hover { background:#45a049; }
</style>
</head>
<body>
<header>
<h1>IoT Health Monitoring Dashboard</h1>
<p id="lastUpdate">Last Update: --:--:--</p>
</header>

<section id="gauges">
<div class="gauge-card">
<h3>Temperature</h3>
<canvas id="tempGauge" width="150" height="150"></canvas>
<p id="tempValue">-- 째C</p>
</div>
<div class="gauge-card">
<h3>Heart Rate</h3>
<canvas id="bpmGauge" width="150" height="150"></canvas>
<p id="bpmValue">-- BPM</p>
</div>
<div class="gauge-card">
<h3>Humidity</h3>
<canvas id="humidityGauge" width="150" height="150"></canvas>
<p id="humidityValue">-- %</p>
</div>
</section>

<section class="card">
<h3>Live Readings (Last 20)</h3>
<canvas id="liveChart"></canvas>
</section>

<section class="card">
<h3>Last 24h History</h3>
<canvas id="historyChart"></canvas>
<button id="downloadCSV">Download CSV</button>
</section>

<script>
// --- Gauges ---
function createGauge(id, max, startAngle=-Math.PI/2, endAngle=Math.PI/2) {
  const opts = { angle:endAngle-startAngle, lineWidth:0.3, radiusScale:0.9, pointer:{length:0.6,strokeWidth:0.03,color:'#000'}, limitMax:false, limitMin:false, highDpiSupport:true, staticZones:[], staticLabels:[] };
  const g = new Gauge(document.getElementById(id)).setOptions(opts);
  g.maxValue = max; g.setMinValue(0); g.animationSpeed=32; g.set(0);
  return g;
}

const tempGauge=createGauge("tempGauge",50);
const bpmGauge=createGauge("bpmGauge",180);
const humidityGauge=createGauge("humidityGauge",100);

function setGaugeColor(gauge,value,thresholds){
  let color=value<thresholds.low?thresholds.lowColor:value>thresholds.high?thresholds.highColor:thresholds.normalColor;
  gauge.options.pointer.color=color; gauge.options.colorStart=color; gauge.options.colorStop=color; gauge.set(value);
}

// --- Charts ---
const liveCtx=document.getElementById('liveChart').getContext('2d');
const liveChart=new Chart(liveCtx,{type:'line',data:{labels:[],datasets:[
  {label:'Temperature (째C)', data:[], borderColor:'#ff9800', fill:false, tension:0.4},
  {label:'Heart Rate (BPM)', data:[], borderColor:'#f44336', fill:false, tension:0.4},
  {label:'Humidity (%)', data:[], borderColor:'#03a9f4', fill:false, tension:0.4}
]}, options:{responsive:true, scales:{y:{beginAtZero:true}}, plugins:{tooltip:{callbacks:{afterBody:function(context){let last5=context[0].dataset.data.slice(-5);return 'Last 5: '+last5.join(', ');}}}}, elements:{point:{radius:4, hoverRadius:6, pointStyle:'circle'}}}});

const histCtx=document.getElementById('historyChart').getContext('2d');
const historyChart=new Chart(histCtx,{type:'line',data:{labels:[],datasets:[
  {label:'Temperature (째C)', data:[], borderColor:'#ff9800', fill:false, tension:0.4},
  {label:'Heart Rate (BPM)', data:[], borderColor:'#f44336', fill:false, tension:0.4},
  {label:'Humidity (%)', data:[], borderColor:'#03a9f4', fill:false, tension:0.4}
]}, options:{responsive:true, scales:{y:{beginAtZero:true}}, plugins:{tooltip:{callbacks:{afterBody:function(context){let last5=context[0].dataset.data.slice(-5);return 'Last 5: '+last5.join(', ');}}}}}});

// --- Live GET Data ---
let lastLiveTimestamp=null;
const channelID=3128115;
const apiKey="KAUQ35X9SMMOAML8";
const thingspeakURL=`https://api.thingspeak.com/channels/${channelID}/feeds.json?api_key=${apiKey}&results=100`;

function updateLastUpdate(){document.getElementById('lastUpdate').textContent="Last Update: "+new Date().toLocaleTimeString();}
function getQueryParams(){const params=new URLSearchParams(window.location.search);return {temp:params.get('temp')?parseFloat(params.get('temp')):null,hum:params.get('hum')?parseFloat(params.get('hum')):null,bpm:params.get('bpm')?parseFloat(params.get('bpm')):null,time:new Date().toLocaleTimeString()};}

function updateLiveFromGET(){
  const {temp,bpm,hum,time}=getQueryParams();
  if(!temp&&!bpm&&!hum)return;
  if(lastLiveTimestamp===time)return;
  lastLiveTimestamp=time;

  if(temp!==null){ setGaugeColor(tempGauge,temp,{low:36,high:37.5,lowColor:'#2196f3',normalColor:'#4caf50',highColor:'#f44336'}); document.getElementById('tempValue').textContent=temp+" 째C"; liveChart.data.datasets[0].data.push(temp);}
  if(bpm!==null){ setGaugeColor(bpmGauge,bpm,{low:60,high:100,lowColor:'#2196f3',normalColor:'#4caf50',highColor:'#f44336'}); document.getElementById('bpmValue').textContent=bpm+" BPM"; liveChart.data.datasets[1].data.push(bpm);}
  if(hum!==null){ setGaugeColor(humidityGauge,hum,{low:30,high:60,lowColor:'#ff9800',normalColor:'#4caf50',highColor:'#03a9f4'}); document.getElementById('humidityValue').textContent=hum+" %"; liveChart.data.datasets[2].data.push(hum);}

  liveChart.data.labels.push(time);
  if(liveChart.data.labels.length>20){liveChart.data.labels.shift(); liveChart.data.datasets.forEach(ds=>{ds.data.shift();});}
  liveChart.update();
  updateLastUpdate();
}

async function fetchHistory(){
  try{
    const res=await fetch(thingspeakURL);
    const data=await res.json();
    if(!data.feeds||data.feeds.length===0)return;
    const labels=data.feeds.map(f=>new Date(f.created_at).toLocaleTimeString());
    const tempData=data.feeds.map(f=>parseFloat(f.field1));
    const bpmData=data.feeds.map(f=>parseFloat(f.field3));
    const humData=data.feeds.map(f=>parseFloat(f.field2));

    historyChart.data.datasets[0].borderColor=tempData.map(v=>v>37.5?'#f44336':'#ff9800');
    historyChart.data.datasets[1].borderColor=bpmData.map(v=>v<60||v>100?'#f44336':'#f44336');
    historyChart.data.datasets[2].borderColor=humData.map(v=>v<30||v>60?'#f44336':'#03a9f4');

    historyChart.data.labels=labels;
    historyChart.data.datasets[0].data=tempData;
    historyChart.data.datasets[1].data=bpmData;
    historyChart.data.datasets[2].data=humData;
    historyChart.update();
  }catch(e){console.error("Error fetching ThingSpeak data:",e);}
}

// --- CSV Download ---
document.getElementById("downloadCSV").addEventListener("click",async()=>{
  try{
    const res=await fetch(thingspeakURL);
    const data=await res.json();
    if(!data.feeds)return;
    const rows=data.feeds.map(f=>`${f.created_at},${f.field1},${f.field2},${f.field3}`);
    const csvContent="Date,Temperature,Humidity,BPM\n"+rows.join("\n");
    const blob=new Blob([csvContent],{type:'text/csv'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a"); a.href=url; a.download="health_data.csv"; a.click();
    URL.revokeObjectURL(url);
  }catch(e){console.error("CSV download error:",e);}
});

setInterval(updateLiveFromGET,5000);
setInterval(fetchHistory,15000);
</script>
</body>
</html>
