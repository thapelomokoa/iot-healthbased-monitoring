<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IoT Health Monitoring Dashboard</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gaugeJS/dist/gauge.min.js"></script>
<style>
  body { background: #f7f8fa; font-family: 'Poppins', sans-serif; }
  h1 { text-align: center; margin: 20px 0; color: #007bff; font-weight: 600; }
  .card { border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
  .gauge-container { width: 200px; height: 200px; margin: auto; }
  footer { margin-top: 40px; text-align: center; color: #888; }
</style>
</head>
<body>

<div class="container">
  <h1>IoT Health Monitoring Dashboard</h1>
  <div class="row text-center">

    <div class="col-md-4 mb-4">
      <div class="card p-3">
        <h5>Body Temperature (°C)</h5>
        <div class="gauge-container"><canvas id="tempGauge"></canvas></div>
        <h4 id="tempValue" class="mt-2 text-primary">-- °C</h4>
      </div>
    </div>

    <div class="col-md-4 mb-4">
      <div class="card p-3">
        <h5>Heart Rate (BPM)</h5>
        <div class="gauge-container"><canvas id="bpmGauge"></canvas></div>
        <h4 id="bpmValue" class="mt-2 text-danger">-- BPM</h4>
      </div>
    </div>

    <div class="col-md-4 mb-4">
      <div class="card p-3">
        <h5>Humidity (%)</h5>
        <div class="gauge-container"><canvas id="humidityGauge"></canvas></div>
        <h4 id="humidityValue" class="mt-2 text-success">-- %</h4>
      </div>
    </div>
  </div>

  <div class="card p-4 mt-3">
    <h5 class="text-center mb-3">Live Health Data Graph</h5>
    <canvas id="healthChart"></canvas>
  </div>

  <div class="text-center mt-4">
    <button class="btn btn-outline-primary" id="downloadCSV">Download Data (CSV)</button>
  </div>
</div>

<footer class="mt-5">
  <p>© 2025 Thapelo Mokoa | IoT Health Monitoring System</p>
</footer>

<script>
const channelID = "3128115"; // ThingSpeak Channel ID
const apiKey = "KAUQ35X9SMMOAML8"; // ThingSpeak Read API Key

const tempGauge = new Gauge(document.getElementById("tempGauge")).setOptions({ colorStart: '#ff5722', colorStop: '#ff9800' });
tempGauge.maxValue = 50; tempGauge.setMinValue(0);

const bpmGauge = new Gauge(document.getElementById("bpmGauge")).setOptions({ colorStart: '#f44336', colorStop: '#e91e63' });
bpmGauge.maxValue = 180; bpmGauge.setMinValue(40);

const humidityGauge = new Gauge(document.getElementById("humidityGauge")).setOptions({ colorStart: '#03a9f4', colorStop: '#00bcd4' });
humidityGauge.maxValue = 100; humidityGauge.setMinValue(0);

const ctx = document.getElementById('healthChart').getContext('2d');
const healthChart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: [],
    datasets: [
      { label: 'Temperature (°C)', data: [], borderColor: '#ff9800', fill: false },
      { label: 'Heart Rate (BPM)', data: [], borderColor: '#f44336', fill: false },
      { label: 'Humidity (%)', data: [], borderColor: '#03a9f4', fill: false }
    ]
  },
  options: {
    responsive: true,
    scales: { y: { beginAtZero: true } }
  }
});

async function fetchData() {
  try {
    const response = await fetch(`https://api.thingspeak.com/channels/${channelID}/feeds.json?api_key=${apiKey}&results=20`);
    const data = await response.json();
    const feeds = data.feeds;

    const labels = feeds.map(f => new Date(f.created_at).toLocaleTimeString());
    const temp = feeds.map(f => parseFloat(f.field1));
    const bpm = feeds.map(f => parseFloat(f.field3));
    const humidity = feeds.map(f => parseFloat(f.field2));

    document.getElementById("tempValue").textContent = temp.at(-1) + " °C";
    document.getElementById("bpmValue").textContent = bpm.at(-1) + " BPM";
    document.getElementById("humidityValue").textContent = humidity.at(-1) + " %";

    tempGauge.set(temp.at(-1));
    bpmGauge.set(bpm.at(-1));
    humidityGauge.set(humidity.at(-1));

    healthChart.data.labels = labels;
    healthChart.data.datasets[0].data = temp;
    healthChart.data.datasets[1].data = bpm;
    healthChart.data.datasets[2].data = humidity;
    healthChart.update();

  } catch(err) {
    console.error("Error fetching data:", err);
  }
}

fetchData();
setInterval(fetchData, 15000); // Update every 15s

document.getElementById("downloadCSV").addEventListener("click", async () => {
  const response = await fetch(`https://api.thingspeak.com/channels/${channelID}/feeds.json?api_key=${apiKey}&results=100`);
  const data = await response.json();
  const rows = data.feeds.map(f => [f.created_at, f.field1, f.field3, f.field2]);
  let csvContent = "Time,Temperature (°C),BPM,Humidity (%)\n" + rows.map(e => e.join(",")).join("\n");

  const blob = new Blob([csvContent], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "health_data.csv";
  a.click();
});
</script>

</body>
</html>
