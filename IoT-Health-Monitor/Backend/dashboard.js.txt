const express = require('express');
const router = express.Router();
const jwt = require('jsonwebtoken');
const User = require('../models/User');
const Patient = require('../models/Patient');

// Middleware to verify token
function auth(req,res,next){
  const token = req.header('x-auth-token');
  if(!token) return res.status(401).json({ msg: 'No token' });
  try{
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    req.user = decoded;
    next();
  }catch(err){ res.status(401).json({ msg: 'Token invalid' }); }
}

// Get assigned patients for doctor
router.get('/assignedPatients', auth, async (req,res)=>{
  try{
    const doctor = await User.findById(req.user.id).populate('assignedPatients');
    res.json(doctor.assignedPatients);
  }catch(err){ res.status(500).json({ msg: err.message }); }
});

// Get ThingSpeak data for a patient
router.get('/patient/:id', auth, async (req,res)=>{
  try{
    const patient = await Patient.findById(req.params.id);
    if(!patient) return res.status(404).json({ msg: 'Patient not found' });

    const response = await fetch(`https://api.thingspeak.com/channels/${patient.thingspeakChannel}/feeds.json?api_key=${patient.thingspeakAPIKey}&results=50`);
    const data = await response.json();
    res.json(data);
  }catch(err){ res.status(500).json({ msg: err.message }); }
});

module.exports = router;
