const mongoose = require('mongoose');
const bcrypt = require('bcryptjs');
require('dotenv').config();

const User = require('./models/User');
const Patient = require('./models/Patient');

mongoose.connect(process.env.MONGO_URI, { useNewUrlParser: true, useUnifiedTopology: true })
  .then(()=> console.log('MongoDB connected for seeding'))
  .catch(err=> console.error(err));

async function seed(){
  try{
    await User.deleteMany();
    await Patient.deleteMany();

    const patients = [
      { name: 'John Doe', unit: 'A101', thingspeakChannel: 3128115, thingspeakAPIKey: 'K72OYJMYOJZN240T' },
      { name: 'Jane Doe', unit: 'A102', thingspeakChannel: 3128115, thingspeakAPIKey: 'K72OYJMYOJZN240T' }
    ];
    const createdPatients = await Patient.insertMany(patients);

    const users = [
      { name: 'Dr. Smith', email: 'doctor@hospital.com', password: await bcrypt.hash('DemoPass123',10), role: 'doctor', assignedPatients: createdPatients.map(p=>p._id) },
      { name: 'Gym Manager', email: 'gym@manager.com', password: await bcrypt.hash('DemoPass123',10), role: 'gym' },
      { name: 'John Doe', email: 'john@patient.com', password: await bcrypt.hash('DemoPass123',10), role: 'patient' },
      { name: 'Jane Doe', email: 'jane@patient.com', password: await bcrypt.hash('DemoPass123',10), role: 'patient' }
    ];
    await User.insertMany(users);

    console.log('Seeding completed.');
    process.exit();
  }catch(err){ console.error(err); process.exit(1); }
}

seed();
